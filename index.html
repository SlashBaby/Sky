<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>monitorCV</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <!-- csss -->
    <link rel="stylesheet" href="assets/bootstrap.min.css">
    <link rel="stylesheet" href="css/bubbles.css">
    <link rel="stylesheet" href="css/tree.css">
    </style>
    <!-- js -->
    <script src="assets/jquery3.js"></script>
    <script src="assets/popper.min.js"></script>
    <script src="assets/fileSave.js"></script>
    <script src="assets/d3.v5.min.js"></script>
    <script src="assets/bootstrap.min.js"></script>
    <script src="assets/echarts.min.js"></script>
    <script src="assets/dataTool.js"></script>
    <script src="js/globalVar.js"></script>
    <script src="js/grids.js"></script>
    <script src="js/tree.js"></script>
    <script src="js/bubbles.js"></script>
    <script src="js/areas.js"></script>
    <script src="js/paraCoord.js"></script>
    <script src="js/boxplot.js"></script>
    <script src="js/treemap.js"></script>
    <script src="js/Point/draw_canvas.js"></script>
    <script src="js/Point/global_var.js"></script>
    <script src="js/Point/ui_control.js"></script>
    <script src="js/Point/js/jquery-3.3.1.min.js"></script>
    <script src='js/Point/js/js-colormaps.js'></script>
    <script src='js/Point/js/jquery.timer.js'></script>
    <script src="js/Point/js/papaparse.min.js"></script>
    <!--     <script src="https://cdn.jsdelivr.net/npm/vega@5.4.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/vega-lite@3.3.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/vega-embed@4.2.0"></script> -->
    <script src="https://gw.alipayobjects.com/os/lib/antv/g2/3.4.10/dist/g2.min.js"></script>
    <script src="https://gw.alipayobjects.com/os/antv/pkg/_antv.data-set-0.10.1/dist/data-set.min.js"></script>
    <style>
        * {
        overflow:hidden;
        margin:0px;
        padding:0px;
      }
      #left-wrapper{
        background:#0b2631;
        height: 770px;
      }
      #left-nav{
        background:#0b2631;
        height:50px;
      }
      #left-vis{
        background:#0b2631;
        height: 670px;
        overflow:scroll;
      }

      #main-wrapper{
        background:#0b2631;   
      }
      #main-nav{
        background:#0b2631;
        height:50px;
      }
      #main-vis{
        background:#0b2631;
        height:670px;
      }
      #main-footer{
        background:#0b2631;
        height:50px;
      }      
      #left-main-footer{
        background: #0b2631;
        width: 655px;
      }
      #right-main-footer{
        background: #0b2631;
        width: 655px;
      }
      #canvas {
        margin-top:50px;
        -border: 3px solid rgb(170, 170, 170);width:570px;height:265px;
        background: white
      }

      #canvas2 {
        margin-top:25px;
        -border: 3px solid rgb(170, 170, 170);width:570px;height:265px;
        background: white
      }
      .bg-color{
        background: #0b2631;
      }

      .btn-color{
        background: #5dd1fa;
      }

      label{
        -color: #5dd1fa;
        color:#c6dbef;
        margin-left: 20px;
        margin-right: 20px;
      }
      .select-color{
        background: #c6dbef;
      }
      img{
        margin-left: 30px;
        margin-top: 50px;
      }

      /*.btn-color{
        background: #5dd1fa;
        color:#0b2631;
      }*/
      
    </style>
</head>

<body>
    <div id="header" class="container-fluid bg-color text-white" style="height: 60px">
        <div id="">
            <h3 style="margin: 0;">ChinaVis 2019</h3>
            <em>一个分析会议的监控系统。</em>
        </div>
    </div>
    <div id="container" class="container-fluid bg-color">
        <div class="row">
            <div id="left-wrapper" class="col-2 bg-color">
                <div id="left-content">
                    <div id="left-nav" class="bg-color">
                        <button type="button" id="btn-tree" class="btn btn-color">空间分类</button>
                        <button type="button" id="btn-map" class="btn btn-color">人员分类</button>
                    </div>
                    <div id="left-vis"></div>
                    <div id="left-footer" class='bg-dark'>
                    </div>
                </div>
            </div>
            <div id="main-wrapper" class="col-10">
                <div id="main-nav" class='bg-color row'>
                    <div class="col-9">
                        <button type="button" id="btn-grids" class="btn btn-color">地图</button>
                        <button type="button" id="btn-bubbles" class="btn btn-color">气泡图</button>
                        <button type="button" id="btn-areas" class="btn btn-color">面积图</button>
                        <button type="button" id="btn-scatter" class="btn btn-color" onclick="scatter()">散点图</button>
                        <button type="button" id="btn-parallelCoord" class="btn btn-color">平行坐标系</button>
                        <button type="button" id="btn-boxplot" class="btn btn-color">箱线图</button>
                    </div>
                    <div class="btn-toolbar">
                        <div class="">
                            <button type="button" id="btn-update" class="btn btn-color">更新图表</button>
                            <button type="button" id="btn-save-data" class="btn btn-color">保存数据</button>
                        </div>
                        &nbsp;
                        <div class="input-group">
                            <select id="day_select" class="btn-color custom-select">
                                <option value="1">第一天</option>
                                <option value="2">第二天</option>
                                <option value="3">第三天</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div id="main-vis" class='row'></div>
            </div>
            <!-- <div id="right-wrapper" class="col-3">
                <div id="right-vis">
                </div>
            </div> -->
        </div>
    </div>
    <script>

    function scatter(){
        console.log('scatter');
        clearMainVis();
        currentVis = 'scatter';
        d3.select('#main-vis')
            .append('img')
            .attr('src', 'data/img/QQ20190609-202726@2x.png')
            .attr('height', '600')
            .attr('width', '1300');

    }
    //监听添加tag
    dispatch.on('addtag', selectedId => {
        console.log(selectedId);
        allpeople.forEach(d => {
            if (selectedId.indexOf(d.id) != -1) {
                d.isSelected = true;
            }
        });
        dispatch.call('inittreemap', this, allpeople);
    })

    //读取树的数据
    d3.json('data/grids/grids_2019_6_9 下午1_07_32.json').then(function(grids_data) {
        console.log('[load data] grids', grids_data);

        const { grids, types } = grids_data;


        //读取人的数据
        d3.json('data/people/people.json').then(function(people_data) {
            allpeople = people_data;
            //初始化树
            dispatch.call('inittree', this, types);

            d3.select("#btn-map")
                .on('click', () => {
                    dispatch.call('inittreemap', this, allpeople);
                })
            d3.select('#btn-tree')
                .on('click', () => {
                    dispatch.call('inittree', this, types);
                })

            //初始化map
            for (let p of allpeople) {
                peopleById.set(p.id, p);
            }


            //读取传感器数据并初始化表格
            d3.csv('data/sensors/sensor.csv').then(function(sensors_data) {
                console.log('[load data] sensors: ', sensors_data);
                dispatch.call('initgrids', this, grids, sensors_data, types);

                d3.select("#btn-grids")
                    .on('click', () => {
                        dispatch.call('initgrids', this, grids, sensors_data, types);
                    })
                sidByGid = gridMap(grids, sensors_data);

                //初始化人
                // dispatch.call('inittreemap', this, allpeople);
            })

        })



        //读取日志数据
        d3.json('data/sensors/sensor_day1_tmp.json').then(function(log_data) {
            console.log('[load data] log_data', log_data);

            const logsBySid = d3.map(log_data, d => d.s);

            //绑定按钮
            d3.select("#btn-areas")
                .on('click', () => {
                    dispatch.call('initareas', this, logsBySid, types);
                })


            d3.json('data/people/move_log_day1.json').then(function(move_data) {
                // dispatch.call('initbubbles', this, logsBySid, move_data, types);

                d3.select("#btn-bubbles")
                    .on('click', () => {
                        dispatch.call('initbubbles', this, logsBySid, move_data, types);
                    })
            })

        })

        //读取平行坐标系需要的数据
        d3.json('data/people/sid_log_day1.json').then(function(move_and_stay) {
            // dispatch.call('initparacoord', this, move_and_stay, types);
            // dispatch.call('initboxplot', this, move_and_stay, types);

            d3.select('#btn-parallelCoord')
                .on('click', () => {
                    console.log('hhh');
                    dispatch.call('initparacoord', this, move_and_stay, types);
                })
            d3.select('#btn-boxplot')
                .on('click', () => {
                    dispatch.call('initboxplot', this, move_and_stay, types);
                })
        })

        //监听事件
        d3.select('#btn-save-data')
            .on('click', () => {
                console.log('save')
                if (currentLeftVis === 'tree') {
                    saveTree(grids_data)
                } else if (currentLeftVis === 'treemap') {
                    saveToJson(allpeople, 'people')
                }

            });
        d3.select('#btn-update')
            .on('click', () => {
                console.log('update');
                dispatch.call('updatecurrent', this);
            })
    })


    function saveTree(data) {
        console.log('[function] saveTree', data.types);

        data.types = data.types.raw();

        saveToJson(data, 'grids');
    }



    //获得的根据格子的id获得对应sensorid的map
    function gridMap(grids, sensors) {
        const result = {};
        grids.forEach(d => {
            for (let s of sensors) {
                if (s.x == d.x && s.y == d.y && +d.floor == +s.floor) {
                    result[d.id] = s.sid;
                    break;
                }
            }
        })
        return result;
    }

    //判断某些传感器是不是没有日志数据
    function sensorsNoLog(sensors, log) {
        for (let s of sensors) {
            let flag = false;
            for (let l of log) {
                if (+l['s'] === +s['sid']) flag = true;
            }
            if (!flag) {
                console.log(+s['sid']);
            }
        }

    }
    </script>
</body>

</html>